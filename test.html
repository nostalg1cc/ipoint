<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Map</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dark Map">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            overflow: hidden;
            background-color: #000000;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .bottom-container {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            height: 70%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 40px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            transition: height 0.3s ease;
            z-index: 1000;
        }
        
        .bottom-container.collapsed {
            height: 30%;
        }
        
        .drag-handle {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 6px;
            background: #ccc;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s ease;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .drag-handle:hover {
            background: #999;
        }
        
        .container-content {
            padding: 30px 20px 50px 20px;
            height: 100%;
            overflow-y: auto;
        }
        
        .version-footer {
            position: absolute;
            bottom: 10px;
            left: 20px;
            right: 20px;
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 5px;
        }
        
        .refresh-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 20px;
            background: #007bff;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
            transition: all 0.2s ease;
        }
        
        .refresh-button:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        
        .refresh-button:active {
            transform: scale(0.95);
        }
        
        .refresh-button.loading {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="bottom-container" id="bottomContainer">
        <div class="drag-handle" id="dragHandle"></div>
        <button class="refresh-button" id="refreshButton" title="Refresh Location & UI">â†»</button>
        <div class="container-content">
            <h2>Bottom Container</h2>
            <p>This container can be dragged up and down using the pill-shaped handle above.</p>
            <p>Click and drag the handle to toggle between 70% and 30% height.</p>
            <p>Use the refresh button to update your location and check for UI updates.</p>
        </div>
        <div class="version-footer" id="versionFooter">
            Version 1.0.1
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // Initialize map with default location and disable zoom controls
        let map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([40.7128, -74.0060], 14);
        
        let currentLocation = [40.7128, -74.0060];
        let locationMarker = null;
        
        // PWA Cache Version - Update this to force cache refresh
        const CACHE_VERSION = '1.0.1';
        const CACHE_NAME = `dark-map-cache-v${CACHE_VERSION}`;
        
        // Add dark map tiles with no labels (CartoDB Dark No Labels)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // Function to fetch IP location and center map
        async function fetchLocation() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                if (!data.error) {
                    const lat = data.latitude;
                    const lon = data.longitude;
                    currentLocation = [lat, lon];
                    centerMapOnLocation();
                }
            } catch (error) {
                console.error('Error fetching location:', error);
            }
        }
        
        // Function to center map on location based on container state
        function centerMapOnLocation() {
            const container = document.getElementById('bottomContainer');
            const isCollapsed = container.classList.contains('collapsed');
            const zoomLevel = isCollapsed ? 16 : 14;
            
            // Calculate the center point based on visible map area
            const containerHeight = container.offsetHeight;
            const windowHeight = window.innerHeight;
            const visibleMapHeight = windowHeight - containerHeight;
            
            // Calculate offset to center the location in the visible area
            const mapCenterOffset = (containerHeight / 2) / windowHeight;
            const latOffset = mapCenterOffset * 0.1; // Adjust this value to fine-tune positioning
            
            const adjustedLat = currentLocation[0] + latOffset;
            
            map.setView([adjustedLat, currentLocation[1]], zoomLevel);
            
            // Add or update location marker
            if (locationMarker) {
                map.removeLayer(locationMarker);
            }
            locationMarker = L.marker(currentLocation).addTo(map);
        }
        
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // Refresh button functionality
        document.getElementById('refreshButton').addEventListener('click', async () => {
            const refreshButton = document.getElementById('refreshButton');
            refreshButton.classList.add('loading');
            
            try {
                // Refresh location
                await fetchLocation();
                
                // Check for UI updates
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        await registration.update();
                        // Force reload if there's an update
                        if (registration.waiting) {
                            registration.waiting.postMessage({ action: 'skipWaiting' });
                            window.location.reload();
                        }
                    }
                }
            } catch (error) {
                console.error('Refresh failed:', error);
            } finally {
                refreshButton.classList.remove('loading');
            }
        });
        
        // Fetch location when page loads
        document.addEventListener('DOMContentLoaded', fetchLocation);
        
        // Toggle container functionality
        const dragHandle = document.getElementById('dragHandle');
        const bottomContainer = document.getElementById('bottomContainer');
        
        function toggleContainer() {
            const isCollapsed = bottomContainer.classList.contains('collapsed');
            if (isCollapsed) {
                bottomContainer.classList.remove('collapsed');
            } else {
                bottomContainer.classList.add('collapsed');
            }
            centerMapOnLocation();
        }
        
        // Click/tap to toggle
        dragHandle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            toggleContainer();
        });
        
        // Drag to toggle (simplified)
        let isDragging = false;
        let startY = 0;
        let hasMoved = false;
        
        dragHandle.addEventListener('mousedown', (e) => {
            isDragging = true;
            hasMoved = false;
            startY = e.clientY;
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const deltaY = Math.abs(e.clientY - startY);
            if (deltaY > 5) {
                hasMoved = true;
            }
        });
        
        document.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            
            isDragging = false;
            if (hasMoved) {
                toggleContainer();
            }
        });
        
        // Touch support for mobile - simplified toggle
        let touchStartY = 0;
        let touchHasMoved = false;
        
        dragHandle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            isDragging = true;
            touchHasMoved = false;
            touchStartY = e.touches[0].clientY;
        }, { passive: false });
        
        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const deltaY = Math.abs(e.touches[0].clientY - touchStartY);
            if (deltaY > 5) {
                touchHasMoved = true;
            }
        }, { passive: false });
        
        document.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            isDragging = false;
            if (touchHasMoved) {
                toggleContainer();
            }
        }, { passive: false });
        
        // Update version display
        document.getElementById('versionFooter').textContent = `Version ${CACHE_VERSION}`;
        
        // Additional iOS-specific fixes
        dragHandle.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });
        
        dragHandle.addEventListener('gesturechange', (e) => {
            e.preventDefault();
        });
        
        dragHandle.addEventListener('gestureend', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>
